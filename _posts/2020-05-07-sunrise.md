---
layout: post
title: A Sunrise Alarm Clock
hidden: true
---

I built a sunrise alarm clock so I wouldn't need to wake up in the dark during the winter time when the sun rises very late. This was the first PCB I had ever made and I had a lot of fun with it.

{% include image.html
    img="/resources/sunrise/sunrise-board.jpeg"
    title="The finished board"
    caption="The completed project"
%}

The board is powered by an Atmega 238 and has, in no particular order:
- Three power transistors to control the RGB channels of an LED strip
- A power regulator so it can be powered by a 12V wall wart
- A real time clock with a battery backup to keep track of the time
- No surface mount parts because I wasn't sure I could solder them
- Dope sunrise art

---

# Hardware Development

## In the Beginning

I started this project with a cheap clone of the Arduino pro mini driving an LED strip, and the first time I left it on overnight it burned out the power regulator. This probably would not have happened to a legit arduino pro mini, but the cheap clones have to make compromieses in the design to lower costs, and the power regulator is a good way to save on component costs.

I was also keeping track of the time using the atmega's clock, but this isnt' the best approach because if the board lost power for any reason then it would lose the time. Maybe for a microwave that is ok, but not for an alarm clock.

{% include image.html
    img="/resources/sunrise/ldo-example.png"
    caption="Test circuit from <a href='https://www.st.com/resource/en/datasheet/l4931.pdf#page=6'>the datasheet</a> of the L4931 voltage regulator"
%}

My second attempt used [a real time clock module](https://www.adafruit.com/product/3296) I bought from adafruit, and [a better power regulator](https://www.mouser.com/ProductDetail/511-L4931CZ50-AP). Figuring out how to use this power regulator was straightforward because [its datasheet](https://www.st.com/resource/en/datasheet/l4931.pdf#page=6) has an example circuit that was exactly what I was trying to do. All this assembled on a bread board worked great! The LEDs powered up at the scheduled time, but the barel jack was really easy to accidentally pull out of the bread board so I decided I needed to solder some components into a ciurcuit board.


## The Circuit Board Design

[The schematic](https://www.arduino.cc/en/uploads/Main/Arduino-Pro-Mini-schematic.pdf) for the Arduino is open source, so most of the work I needed to do was already done. I knew I wanted to use the L4931 regulator and a barell connector to provide power to the board, so I subbed those into the power regulation section of the Arduino's schematic. The stabilization caps on the Arduino design are larger than those suggested by the L4931 datasheet, so I used the larger ones just to be safe. I have since learned that the smaller ceramic capacitor is used to smooth out higher frequency variations in the output voltage. It has a much lower equivalent series resistance (ESR) than an electrolytic capacitor so it can respond faster, but large ceramic caps are expensive, so the electrolytic capacitor smooths out any low frequency noise on the cheap and the ceramic cap takes care of the high frequency noise. There is also an optional power indication LED I chose not to solder into the board I use because I don't like lights on things in my bedroom.

{% include image.html
    width="100%"
    img="/resources/sunrise/power-regulation.svg"
    caption="Power regulation with an electrolytic and ceramic cap to filter output voltage"
%}

The design of the RTC breakout from Adafruit is not open source, but [the datasheet for the DS1307](https://datasheets.maximintegrated.com/en/ds/DS1307.pdf) is excellent and has an example on the very first page! I sure do appreciate good documentation. There is one additional component on the breakout board I got from Adafruit, but I think it is just a power stabilization capacitor. This clock will keep the time using the backup battery if main power is lost, so if I unplug the board, or the power goes out I don't need to reset the clock. The two pull-up resistors on the `SDA` and `SCL` lines are required by the I<sup>2</sup>C spec. The 32.768kHz crystal is a requirement of the chip. This is a very popular speed for clocks because it makes counting seconds so easy because 32,768 is 2<sup>15</sup>.

{% include image.html
    width="80%"
    img="/resources/sunrise/rtc.svg"
    caption="DS1307 Real Time Clock"
%}

I replicated the setup I had on the original breadboard design for the high power output transistors. The gates are connected to PWM capable outputs on the microcontroller and provide a high capacity current sink for the LED strip when on. Most of the strands I've seen are powered off of 12V and use a common high voltage line, so this setup should be compatible with many LED strips. The pull down resistors on the outputs here prevent the LED strip from momentarily turning on when the microcontroller is reset. The Atmega 328 [sets all pins to input without pull up resistors when it is reset](https://forum.arduino.cc/index.php?topic=57829.msg421711#msg421711) so the voltage at the mosfet gate would be left floating, potentially allowing it to turn on.

{% include image.html
    width="60%"
    img="/resources/sunrise/output-transistors.svg"
    caption="High current output transistors for the RGB channels of the LED strip"
%}

The rest of the schematic is the same as the Arduino board I was using. There is another power stabilization cap drawn very close to the microcontroller. In this case this means that the cap should be physically close to the microcontroller on the board to provide a very stable voltage for it to use. The microcontroller will probably use different amounds of current at high frequency, so this makes sense to me.

The other interesting bit of this part of the schematic is the reset hardware. There is a cap between the `DTR` pin on the programming header and the reset pin on the microcontroller with a pull-up resistor. This is so that if software fails to pull the `DTR` pin high again the board will still reboot after charging the capacitor through the pull-up resistor. The values of the capacitor and resistor here have been tuned so the board is only momentarily off and can talk to the computer properly even if there are bad drivers for the programming cable.

{% include image.html
    width="100%"
    img="/resources/sunrise/micro-controller.svg"
%}

I decided to use only through hole parts because I wasn't sure I had the skill to solder surface mount components. I also wanted to make sure I could debug and expand the design, so I wanted all the standard Arduino pins to be accesible if I plugged it into a bread board. All this means that the board is very skinny so it would fit on a bread board and in order for there to be any room left on the bread board it has to hang way off the end.

{% include image.html
    width="100%"
    img="/resources/sunrise/top.svg"
    caption="Top of the board with many tiny suns"
%}

{% include image.html
    width="100%"
    img="/resources/sunrise/bottom.svg"
    caption="Bottom of the board with one huge rising sun"
%}


---

# The Firmware

What color profile to use?

How to normalize the output of the LED strip?


---

# Wishlist